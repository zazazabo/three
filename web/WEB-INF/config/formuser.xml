<?xml version="1.0" encoding="utf-8"?>
<xforms>
    
    <xform desc="主页" id="mainsub">
        <xhand id="home" rtn="mainsub.jsp" rtnype="PGE">
            <xsql id="a1" list="true" page="true" tpe="SQL" tpl="SELECT COUNT(l_code) AS count FROM t_lamp WHERE l_deplayment = 1  " var="rs1">    
            </xsql>           
            
            <xsql id="a2" list="true" page="true" tpe="SQL" tpl=" SELECT COUNT(f_lampset) AS count FROM t_fault WHERE f_type='ERC44' AND f_wanning=1 AND CONVERT(Nvarchar, f_day, 23) = CONVERT(Nvarchar, GETDATE(), 23)  " var="rs2">    
            </xsql> 

            <xsql id="a3" list="true" page="true" tpe="SQL" tpl=" SELECT power,month(day) AS month FROM t_records AS tr where datediff(month,day,getdate())=0     ORDER BY tr.[day] DESC " var="rs3">    
            </xsql> 

            <xsql id="a4" list="true" page="true" tpe="SQL" tpl=" SELECT * FROM t_planpower  " var="rs4">    
            </xsql> 
           
            <xsql id="a5" list="true" page="true" tpe="SQL" tpl=" SELECT COUNT(DISTINCT tb.comaddr) AS count FROM t_baseinfo AS tb " var="rs5">    
            </xsql>         
            
            <xsql id="a6" list="true" page="true" tpe="SQL" tpl=" SELECT POWER as power,CONVERT(varchar(100),day,112) as day, month(DAY) AS monty,year(DAY) AS year FROM t_records AS tr where datediff(year,DAY,getdate()) BETWEEN 0 AND 2   ORDER BY tr.[day] DESC " var="rs6">    
            </xsql>  

        </xhand>
    </xform>


    <xform desc="告警模块" id="warn">
        <xhandle desc="告警列表" id="queryData" rtnype="JSON">
            <xsql id="a1" list="true" page="true" tpe="SQL" tpl="select * from t_people WHERE   @CONDITION  " var="bootstrap">
                <xflt id="CONDITION" nrp="" tpl="@u_phone AND @u_name ">
                    <xfltpara id="u_phone" nrp="1=1" para="u_phone" sql="u_phone = ':u_phone'">
                    </xfltpara>
                    <xfltpara id="u_name" nrp="1=1" para="u_name" sql="u_name = ':u_name'">
                    </xfltpara>            
                </xflt>      
            </xsql>               
        </xhandle>                 
    </xform>
    
    <xform desc="菜单模块" id="mainmenu">
        <xhandle desc="获取菜单列表" id="query" rtnype="JSON">
            <xsql id="a1" list="true" page="true" tpe="SQL" tpl="SELECT * FROM t_menu tm WHERE   tm.m_code IN   (SELECT code AS m_code FROM t_role tr WHERE enable=1 and   @CONDITION ) ORDER BY m_code ASC  " var="list">
                <xflt id="CONDITION" nrp="" tpl="@type ">
                    <xfltpara id="type" nrp="1!=1" para="type" sql="roletype = :type">
                    </xfltpara>            
                </xflt>        
            </xsql>               
        </xhandle>  
        
        <xhandle desc="获取二菜单列表" id="querysub" rtnype="JSON">
            <xsql id="a1" list="true" page="true" tpe="SQL" tpl=" SELECT * FROM   t_menu tm,t_role tr WHERE tm.m_code=tr.code AND tr.enable=1 AND  @CONDITION   ORDER BY m_code ASC" var="list">
                <xflt id="CONDITION" nrp="" tpl="@role AND @m_parent  ">
                    <xfltpara id="role" nrp="1=1" para="role" sql="roletype = :role">
                    </xfltpara> 
                    <xfltpara id="m_parent" nrp="1=1" para="m_parent" sql="tm.m_parent = :m_parent">
                    </xfltpara>                                  
                </xflt>        
            </xsql>               
        </xhandle>  
       
      <xhandle desc="" id="rolemenu" rtnype="JSON">
            <xsql id="a1" list="true" page="true" tpe="SQL" tpl="SELECT DISTINCT roletype as id,name as text FROM t_role " var="list">
            </xsql>
        </xhandle>                  
        
        <!--{id: 1, pId: 0, name: "[core] 基本功能 演示", open: true},-->
        <xhandle desc="获取菜单列表" id="queryZtree" rtnype="JSON">
            <xsql id="a1" list="true" page="true" tpe="SQL" tpl="select m_code AS id,m_parent as pId,m_title as name,m_icon as icon  from  t_menu   WHERE m_type=0 and   @CONDITION  ORDER BY m_code ASC  " var="list">
                <xflt id="CONDITION" nrp="" tpl="@u_phone AND @u_name ">
                    <xfltpara id="u_phone" nrp="1=1" para="u_phone" sql="u_phone = ':u_phone'">
                    </xfltpara>
                    <xfltpara id="u_name" nrp="1=1" para="u_name" sql="u_name = ':u_name'">
                    </xfltpara>             
                </xflt>        
            </xsql>               
        </xhandle>                   
                                                     
    </xform>
    
    

    
    
    <xform desc="人员表" id="user">
        <xhandle desc="获取人员列表" id="query" rtnype="JSON">
            <xsql id="a1" list="true" page="true" tpe="SQL" tpl="select * from  t_user    WHERE   @CONDITION   " var="bootstrap">
                <xflt id="CONDITION" nrp="" tpl="@u_phone AND @u_name ">
                    <xfltpara id="u_phone" nrp="1=1" para="u_phone" sql="u_phone = ':u_phone'"> 
                    </xfltpara>
                    <xfltpara id="u_name" nrp="1=1" para="u_name" sql="u_name = ':u_name'">
                    </xfltpara>             
                </xflt>        
            </xsql>               
        </xhandle>  
        
        <xhandle desc="删除用户表" id="deleteUser" rtn="rs" rtnype="JSON">
            <xsql id="a1" tpe="DDL" tpl="delete from t_user where @CONDITION " var="rs">
                <xflt id="CONDITION" tpl="@id ">
                    <xfltpara id="id" nrp="1=1" para="id" sql="id =  :id ">
                    </xfltpara>
                </xflt>
            </xsql>
        </xhandle>     
       
        <xhandle desc="添加用户" id="addUser" rtn="rs" rtnype="JSON">
            <xsql id="a1" para="name,sex,phone,department,email,password" tpe="DDL" tpl="insert into t_user(name,sex,phone,department,email,password) values(':name',':sex',':phone',':department',':email',':password') " var="rs">
            </xsql>
        </xhandle>         
            
        <xhandle desc="修改用户" id="editUser" rtn="rs" rtnype="JSON">
            <xsql id="a1" para="department,sex,email,phone" tpe="DDL" tpl="update t_user set department=':department',sex=':sex',email=':email',phone=':phone' where @CONDITION " var="rs">
                <xflt id="CONDITION" nrp="" tpl="@id ">
                    <xfltpara id="id" nrp="1=1" para="id" sql="id=:id">
                    </xfltpara>
                </xflt>
            </xsql>
        </xhandle>  
              
        <xhandle desc="修改用户权限" id="editUserAuthor" rtn="rs" rtnype="JSON">
            <xsql id="a1" para="author" tpe="DDL" tpl="update t_user set author=':author' where @CONDITION " var="rs">
                <xflt id="CONDITION"  tpl="@id ">
                    <xfltpara id="id"  para="id" sql="id=:id">
                    </xfltpara>
                </xflt>
            </xsql>
        </xhandle>                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    </xform>
    
</xforms>
